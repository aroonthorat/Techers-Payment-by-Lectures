
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }
    
    function isTeacher() {
      return request.auth.token.role == 'teacher';
    }
    
    function isAuthenticatedUser() {
      return request.auth != null;
    }

    function isTeacherAssignedToExam(teacherId, examId) {
      // In production, we'd use a specific naming convention or standard query
      // This exists check is a demonstration of the requested verification logic
      return exists(/databases/$(database)/documents/teacherExamAssignments/$(teacherId + "_" + examId));
    }
    
    // Exams: Admins can CRUD, Teachers can READ
    match /exams/{examId} {
      allow read: if isAuthenticatedUser();
      allow create, update, delete: if isAdmin();
    }
    
    // Exam Subjects & Papers: Admins CRUD, Teachers READ
    match /examSubjects/{docId} { allow read: if isAuthenticatedUser(); allow write: if isAdmin(); }
    match /examPapers/{docId} { allow read: if isAuthenticatedUser(); allow write: if isAdmin(); }
    
    // Teacher Assignments: Admins CRUD, Teachers READ ONLY their own
    match /teacherExamAssignments/{docId} {
      allow read: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }
    
    // Mark Entries: CRITICAL SECURITY
    match /markEntries/{docId} {
      // READ: Admins see all. Teachers see assignments assigned to them
      allow read: if isAdmin() || (isTeacher() && (resource == null || resource.data.teacherId == request.auth.uid));
      
      // WRITE: Only via Cloud Functions or specifically authorized teachers
      allow update: if (isAdmin()) || 
                      (isTeacher() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       resource.data.status != 'verified'); // Locked if verified
      
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Core Master Data
    match /subjects/{docId} { allow read: if isAuthenticatedUser(); allow write: if isAdmin(); }
    match /students/{docId} { allow read: if isAuthenticatedUser(); allow write: if isAdmin(); }
    match /teachers/{docId} {
      allow read: if isAdmin() || (isTeacher() && docId == request.auth.uid);
      allow create, update: if isAdmin();
    }

    // Financial Data: ADMIN ONLY
    match /payments/{docId} { allow read, write: if isAdmin(); }
    match /advances/{docId} { allow read, write: if isAdmin(); }
    match /feePayments/{docId} { allow read, write: if isAdmin(); }
  }
}
